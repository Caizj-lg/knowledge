name: Notify Feishu on Tool Submission

on:
  repository_dispatch:
    types: [tool_submission]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          set -e
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "FEISHU_WEBHOOK_URL is not set"
            exit 1
          fi

          # Extract toolName from event payload with grep/sed (no python, no heredoc)
          TOOL_NAME=$(grep -o '"toolName"[[:space:]]*:[[:space:]]*"[^"]*"' "$GITHUB_EVENT_PATH" | head -n 1 | sed 's/.*"toolName"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
          [ -z "$TOOL_NAME" ] && TOOL_NAME="(empty)"

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"新的工具提交\\n工具名称: ${TOOL_NAME}\"}}" \
            "$FEISHU_WEBHOOK_URL"

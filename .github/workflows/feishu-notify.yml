name: Notify Feishu on Tool Submission

on:
  repository_dispatch:
    types: [tool_submission]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build Feishu payload
        id: build
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY' > payload.json
import json
import os

event = json.loads(os.environ.get("GITHUB_EVENT_PATH") and open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8").read() or "{}")
submission = (event.get("client_payload") or {})

def join_list(items):
    return "、".join(items) if items else "无"

text = "\n".join([
    "新的工具提交",
    f"分类: {submission.get('category', '')}",
    f"工具名称: {submission.get('toolName', '')}",
    f"网站链接: {submission.get('website', '')}",
    f"说明: {submission.get('description', '')}",
    f"标签: {join_list(submission.get('tags', []))}",
    f"适用场景: {join_list(submission.get('scenarios', []))}",
    f"提交者: {submission.get('submitter', '')}",
    f"提交时间: {submission.get('submittedAt', '')}",
])

payload = {"msg_type": "text", "content": {"text": text}}
print(json.dumps(payload, ensure_ascii=False))
PY
          echo "payload_path=payload.json" >> "$GITHUB_OUTPUT"

      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${FEISHU_WEBHOOK_URL:-}" ]; then
            echo "FEISHU_WEBHOOK_URL is not set."
            exit 1
          fi
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "$FEISHU_WEBHOOK_URL"
